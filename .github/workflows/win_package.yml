name: windows-package

on:
  push:
    tags:
      - 'v*'

jobs:
  platform-build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
    env:
      QT_VERSION: 6.8.0
      BUILD_TYPE: Release

    steps:
      - name: Checkout Source code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          cache: true
          cache-key-prefix: 'Qt'

      - name: Configure CMake
        run: cmake -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build
        run: cmake --build ${{ github.workspace }}/build --config ${{ env.BUILD_TYPE }}

      - name: Set reusable strings for output dir
        id: strings
        shell: bash
        # Note: `build/src/BUILD_TYPE` structure is created by CMake on Windows
        run: |
          echo "build-output-dir=${{ github.workspace }}/build/src/${{ env.BUILD_TYPE }}" >> "$GITHUB_OUTPUT"
          echo "installer-dir=${{ github.workspace }}/build/src/output" >> "$GITHUB_OUTPUT"

      - name: Install NSIS (Windows)
        run: |
          choco install nsis -y
          echo "NSIS_PATH=C:\Program Files\NSIS" >> $env:GITHUB_ENV

      - name: Run Packaging Script (Windows)
        run: |
          python3 scripts/build_windows_package.py --output-dir ${{ steps.strings.outputs.build-output-dir }}
        working-directory: ${{ github.workspace }}

      # # For CD test
      # - name: Upload Windows installer as Artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: QClipboard-Windows-Installer
      #     path: ${{ steps.strings.outputs.installer-dir }}/QClipboard*.exe
      #     retention-days: 7
          
      - name: Create Release and Upload Artifacts
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.strings.outputs.installer-dir }}/QClipboard*.exe
          draft: false
          prerelease: false
          generate_release_notes: true